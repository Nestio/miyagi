const fs = require('fs');
const path = require('path');

// Read all MDX files and extract method information
const partnerApiDir = path.resolve(__dirname, '..', 'docs', 'apis', 'partner-api');
const mappings = {};

function extractMethodFromMDX(filePath) {
  const content = fs.readFileSync(filePath, 'utf8');
  const methodMatch = content.match(/method="([A-Z]+)"/);
  return methodMatch ? methodMatch[1] : null;
}

function walkDir(dir, fileList = []) {
  const files = fs.readdirSync(dir);
  files.forEach(file => {
    const filePath = path.join(dir, file);
    if (fs.statSync(filePath).isDirectory()) {
      walkDir(filePath, fileList);
    } else if (file.endsWith('.mdx') && file !== 'index.mdx') {
      fileList.push(filePath);
    }
  });
  return fileList;
}

const mdxFiles = walkDir(partnerApiDir);

mdxFiles.forEach(filePath => {
  const method = extractMethodFromMDX(filePath);
  if (method) {
    // Convert file path to URL path
    // e.g., docs/apis/partner-api/appointment-booking/10-get-dates.mdx
    // -> /apis/partner-api/appointment-booking/10-get-dates
    const relativePath = path.relative(partnerApiDir, filePath);
    const dir = path.dirname(relativePath);
    const filename = path.basename(relativePath, '.mdx');
    const urlPath = `/apis/partner-api/${dir === '.' ? filename : `${dir}/${filename}`}`;
    mappings[urlPath] = method;
  }
});

// Write mappings file
const clientDir = path.resolve(__dirname, '..', 'src', 'client');
if (!fs.existsSync(clientDir)) {
  fs.mkdirSync(clientDir, { recursive: true });
}

const mappingsFile = path.join(clientDir, 'partner-api-badge-mappings.js');
const content = `// Auto-generated by generate-partner-api-docs.cjs
// Do not edit manually - regenerate docs to update

module.exports = {
  partnerApiEndpointMethodMap: ${JSON.stringify(mappings, null, 2)},
};
`;

fs.writeFileSync(mappingsFile, content);
console.log(`Generated ${Object.keys(mappings).length} badge mappings`);
console.log(`Output: ${mappingsFile}`);

